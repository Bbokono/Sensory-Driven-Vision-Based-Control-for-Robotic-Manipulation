#!/usr/bin/env python3
import os
import glob
import pandas as pd
import datetime
import sys

# Check for fpdf
try:
    from fpdf import FPDF
except ImportError:
    print("Error: 'fpdf' library not found. Please install it using: pip3 install fpdf")
    sys.exit(1)


class PDFReport(FPDF):
    def header(self):
        self.set_font("Arial", "B", 10)
        self.set_text_color(44, 62, 80)  # Dark blue-grey
        self.cell(
            0,
            10,
            "Sensory-Driven Vision-Based Control for Robotic Manipulation",
            0,
            1,
            "C",
        )
        self.set_draw_color(44, 62, 80)
        self.set_line_width(0.5)
        self.line(10, 20, 200, 20)
        self.ln(5)

    def footer(self):
        self.set_y(-15)
        self.set_font("Arial", "I", 8)
        self.set_text_color(128)
        self.cell(0, 10, "Page " + str(self.page_no()) + "/{nb}", 0, 0, "C")

    def chapter_title(self, title, link=None):
        if link is not None:
            self.set_link(link)
        self.set_font("Arial", "B", 14)
        self.set_fill_color(230, 230, 230)  # Light gray background
        self.set_text_color(0)
        self.cell(0, 10, f" {title}", 0, 1, "L", fill=True)
        self.ln(5)

    def chapter_body(self, body):
        self.set_font("Arial", "", 11)
        self.set_text_color(50)
        self.multi_cell(0, 6, body)
        self.ln()

    def add_image(self, image_path, title, link=None):
        if os.path.exists(image_path):
            self.add_page()
            self.chapter_title(title, link=link)
            # Adjust width to fit page (A4 width is ~210mm, margins are 10mm)
            self.image(image_path, x=10, w=190)
            self.ln(10)
        else:
            print(f"Warning: Image {image_path} not found.")


def generate_report():
    # Find latest results
    possible_paths = [
        "/root/catkin_ws",
        os.path.abspath(os.path.join(os.path.dirname(__file__), "../../")),
        os.path.abspath(os.path.join(os.path.dirname(__file__), "../")),
        os.getcwd(),
    ]

    csv_file = None
    for p in possible_paths:
        if os.path.isdir(p):
            files = glob.glob(os.path.join(p, "*_results_*.csv"))
            if files:
                csv_file = max(files, key=os.path.getctime)
                break

    if not csv_file:
        print("No result CSV found. Run the simulation and plotting script first.")
        return

    print(f"Generating report based on data: {csv_file}")
    base_name = os.path.splitext(csv_file)[0]
    img_summary = f"{base_name}_summary.png"
    img_joints = f"{base_name}_joint_velocities.png"
    img_stats = f"{base_name}_error_stats.png"

    pdf = PDFReport()
    pdf.alias_nb_pages()

    # --- Define TOC Structure ---
    sections = [
        "1. Introduction",
        "2. Methodology",
        "3. Experimental Results",
        "4. Data Logs (Sample)",
        "Appendix A: Source Code",
    ]
    section_links = {sec: pdf.add_link() for sec in sections}

    # --- Title Page ---
    pdf.add_page()
    pdf.ln(60)
    pdf.set_font("Arial", "B", 24)
    pdf.cell(0, 10, "Project Report", 0, 1, "C")
    pdf.ln(10)
    pdf.set_font("Arial", "B", 18)
    pdf.cell(0, 10, "Sensory-Driven Vision-Based Control", 0, 1, "C")
    pdf.cell(0, 10, "for Robotic Manipulation", 0, 1, "C")
    pdf.ln(30)
    pdf.set_font("Arial", "", 12)
    pdf.cell(
        0, 10, f'Date: {datetime.datetime.now().strftime("%Y-%m-%d %H:%M")}', 0, 1, "C"
    )
    pdf.cell(0, 10, "Generated by: Automated Reporting System", 0, 1, "C")

    # --- Table of Contents ---
    pdf.add_page()
    pdf.set_font("Arial", "B", 16)
    pdf.cell(0, 10, "Table of Contents", 0, 1, "C")
    pdf.ln(10)
    pdf.set_font("Arial", "", 12)
    for sec in sections:
        pdf.cell(0, 10, sec, 0, 1, "L", link=section_links[sec])

    # --- Introduction ---
    pdf.add_page()
    pdf.chapter_title("1. Introduction", link=section_links["1. Introduction"])
    intro_text = (
        "This project implements a sensory-driven vision-based control system for robotic manipulation "
        "using a UR5 robot in a Gazebo simulation environment. The system integrates computer vision "
        "using YOLOv5 for object detection and pose estimation, with a motion planning framework "
        "capable of executing precise pick-and-place tasks.\n\n"
        "The primary objective is to demonstrate robust control strategies, comparing kinematic "
        "trajectory planning with Model Predictive Control (MPC) approaches. The system handles "
        "dynamic environments where objects (LEGO bricks) are identified, localized, and manipulated "
        "to build specific structures."
    )
    pdf.chapter_body(intro_text)

    # --- Methodology ---
    pdf.chapter_title("2. Methodology", link=section_links["2. Methodology"])
    method_text = (
        "2.1 Vision System\n"
        "The vision system utilizes an RGB-D camera mounted in the simulation. "
        "A YOLOv5 model, trained on custom datasets, detects LEGO bricks and estimates their "
        "orientation. Depth data is used to compute the precise 3D coordinates of the objects relative "
        "to the robot base.\n\n"
        "2.2 Present Controller\n"
        "The system utilizes a custom Kinematic Trajectory Controller implemented in the 'ArmController' class. "
        "This controller operates by calculating the exact joint configurations required to achieve a target "
        "Cartesian pose using an analytical Inverse Kinematics (IK) solver. It interfaces with the standard "
        "ROS JointTrajectoryController to execute motion commands, ensuring precise geometric positioning.\n\n"
        "2.3 Path Planning Strategy\n"
        "Path planning is performed using Linear Cartesian Interpolation. The controller computes a straight-line "
        "path in 3D space from the start to the goal position. This path is discretized into fine steps, "
        "and a cosine-based smoothing function is applied to the interpolation parameter. This technique "
        "generates a velocity profile with smooth acceleration and deceleration, minimizing jerk and ensuring "
        "stable motion during pick-and-place operations."
    )
    pdf.chapter_body(method_text)

    # --- Results Section ---
    pdf.add_page()
    pdf.chapter_title(
        "3. Experimental Results", link=section_links["3. Experimental Results"]
    )
    pdf.chapter_body(
        "The following section presents the quantitative results from the latest simulation run."
    )

    pdf.add_image(img_summary, "3.1 Trajectory Summary")
    pdf.chapter_body(
        "The plot above shows the 3D trajectory of the end-effector. "
        "The alignment between the reference path (dashed red) and the actual path (solid blue) "
        "indicates the tracking accuracy of the controller."
    )

    pdf.add_image(img_joints, "3.2 Joint Velocities")
    pdf.chapter_body(
        "This graph illustrates the velocity profiles of the six UR5 joints during the operation. "
        "Smooth velocity curves suggest stable control without oscillations or jerky movements."
    )

    pdf.add_image(img_stats, "3.3 Error Statistics")
    pdf.chapter_body(
        "The Mean Absolute Error (MAE) and Root Mean Square Error (RMSE) provide a summary of "
        "the positioning accuracy. Lower values indicate higher precision in the manipulation task."
    )

    # --- Data Table ---
    pdf.add_page()
    pdf.chapter_title(
        "4. Data Logs (Sample", link=section_links["4. Data Logs (Sample)"]
    )
    try:
        df = pd.read_csv(csv_file)
        pdf.set_font("Courier", "B", 8)
        cols = ["time", "target_x", "actual_x", "error_dist"]
        header = "".join([f"{col:<15}" for col in cols])
        pdf.cell(0, 5, header, 0, 1)

        pdf.set_font("Courier", "", 8)
        for index, row in df.head(40).iterrows():
            line = "".join(
                [
                    (
                        f"{row[col]:<15.4f}"
                        if isinstance(row[col], float)
                        else f"{str(row[col]):<15}"
                    )
                    for col in cols
                ]
            )
            pdf.cell(0, 4, line, 0, 1)
        pdf.ln()
        pdf.set_font("Arial", "I", 10)
        pdf.cell(0, 10, f"(Showing first 40 rows of {len(df)} total records)", 0, 1)
    except Exception as e:
        pdf.chapter_body(f"Could not load CSV data: {e}")

    # --- Appendix: Source Code ---
    pdf.add_page()
    pdf.chapter_title(
        "Appendix A: Source Code", link=section_links["Appendix A: Source Code"]
    )
    pdf.chapter_body(
        "The following pages contain the complete source code used in this project."
    )

    files_to_include = [
        "/home/bokono/MyThesis/Sensory-Driven Vision-Based Control for Robotic Manipulation/catkin_ws/src/motion_planning/scripts/motion_planning.py",
        "/home/bokono/MyThesis/Sensory-Driven Vision-Based Control for Robotic Manipulation/catkin_ws/src/motion_planning/scripts/controller.py",
        "/home/bokono/MyThesis/Sensory-Driven Vision-Based Control for Robotic Manipulation/catkin_ws/src/vision/scripts/lego-vision.py",
    ]

    for file_path in files_to_include:
        if os.path.exists(file_path):
            pdf.add_page()
            pdf.set_font("Arial", "B", 12)
            pdf.cell(0, 10, f"File: {os.path.basename(file_path)}", 0, 1)
            pdf.ln(2)
            pdf.set_font("Courier", "", 6)  # Small font to fit code

            with open(file_path, "r", encoding="utf-8", errors="replace") as f:
                for line in f:
                    pdf.multi_cell(0, 3, line.replace("\t", "    ").rstrip())

    output_pdf = os.path.join(os.path.dirname(csv_file), f"{base_name}_Report.pdf")
    pdf.output(output_pdf)
    print(f"Report generated successfully: {output_pdf}")


if __name__ == "__main__":
    generate_report()
